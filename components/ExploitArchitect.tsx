
import React, { useState, useMemo } from 'react';
import { 
  Terminal, Zap, Loader2, Copy, Check, Info, 
  ShieldAlert, ShieldCheck, RefreshCw, Cpu, Code, 
  Database, Globe, Layers, AlertCircle, Bug, Activity
} from 'lucide-react';
import { generateExploitPayload } from '../services/gemini';

interface ExploitArchitectProps {
  language: 'en' | 'az';
}

const ExploitArchitect: React.FC<ExploitArchitectProps> = ({ language }) => {
  const [vulnClass, setVulnClass] = useState('Cross-Site Scripting (XSS)');
  const [targetTech, setTargetTech] = useState('Node.js / Express');
  const [context, setContext] = useState('');
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState<any>(null);
  const [copied, setCopied] = useState(false);

  const t = useMemo(() => ({
    en: {
      title: 'Neural Exploit Architect',
      subtitle: 'Precision payload synthesis for authorized research and auditing.',
      config: 'Architecture Parameters',
      vulnClass: 'Vulnerability Class',
      stack: 'Target Technology Stack',
      context: 'Operational Context',
      contextPlaceholder: 'e.g., "Bypassing a simple regex filter", "Blind extraction via OOB"',
      forgeBtn: 'Forge Research Payload',
      forging: 'Synthesizing Neural Logic...',
      output: 'Payload Console',
      mechanism: 'Technical Mechanism',
      behavior: 'Expected Behavior',
      remediation: 'Defensive Strategy',
      copy: 'Copy Payload',
      reset: 'Reset Terminal'
    },
    az: {
      title: 'Neyron Eksployt Arxitekti',
      subtitle: 'Səlahiyyətli tədqiqat və audit üçün dəqiq payload sintezi.',
      config: 'Memarlıq Parametrləri',
      vulnClass: 'Zəiflik Sinfi',
      stack: 'Hədəf Texnologiya Yığını',
      context: 'Əməliyyat Konteksti',
      contextPlaceholder: 'məs: "Sadə regex filtrindən yan keçmə", "OOB vasitəsilə kor çıxarış"',
      forgeBtn: 'Tədqiqat Payload-u Hazırla',
      forging: 'Neyron Məntiq Sintez Edilir...',
      output: 'Payload Konsolu',
      mechanism: 'Texniki Mexanizm',
      behavior: 'Gözlənilən Davranış',
      remediation: 'Müdafiə Strategiyası',
      copy: 'Payload-u Kopyala',
      reset: 'Terminalı Sıfırla'
    }
  }[language]), [language]);

  const VULN_CLASSES = [
    'Cross-Site Scripting (XSS)',
    'SQL Injection (SQLi)',
    'NoSQL Injection',
    'Server-Side Request Forgery (SSRF)',
    'Command Injection',
    'Local File Inclusion (LFI)',
    'Insecure Deserialization',
    'XML External Entity (XXE)',
    'JWT Authentication Bypass'
  ];

  const TECH_STACKS = [
    'Node.js / Express',
    'Python / Django / Flask',
    'PHP / Laravel',
    'Java / Spring Boot',
    'Ruby on Rails',
    'Go / Gin',
    'ASP.NET Core',
    'Nginx / Apache Config'
  ];

  const handleForge = async () => {
    if (loading) return;
    setLoading(true);
    try {
      const data = await generateExploitPayload(vulnClass, context || 'Standard research', targetTech);
      setResult(data);
    } catch (err) {
      alert("Neural synthesis failed. Check network nodes.");
    } finally {
      setLoading(false);
    }
  };

  const handleCopy = () => {
    if (!result?.payload) return;
    navigator.clipboard.writeText(result.payload);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="space-y-10 animate-in slide-up pb-20">
      <div className="flex flex-col md:flex-row md:items-end justify-between gap-6">
        <div className="space-y-3">
          <div className="flex items-center gap-5">
             <div className="w-16 h-16 bg-red-600/10 rounded-2xl flex items-center justify-center shadow-xl border border-red-500/10">
                <Terminal className="text-red-500" size={32} />
             </div>
             <div>
                <span className="text-[10px] font-black text-slate-500 uppercase tracking-[0.4em] block">Payload Foundry</span>
                <h2 className="text-4xl font-black text-white tracking-tighter italic uppercase">{t.title}</h2>
             </div>
          </div>
          <p className="text-slate-400 max-w-2xl font-medium text-sm">
            {t.subtitle}
          </p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        {/* Input Panel */}
        <div className="lg:col-span-4 space-y-6">
          <div className="card p-8 border-slate-800/50 shadow-2xl space-y-8">
            <h3 className="text-xs font-black text-white uppercase tracking-[0.2em] flex items-center gap-3">
              <Layers size={16} className="text-blue-500" /> {t.config}
            </h3>

            <div className="space-y-6">
              <div className="space-y-3">
                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                  <Bug size={12} /> {t.vulnClass}
                </label>
                <select 
                  value={vulnClass}
                  onChange={(e) => setVulnClass(e.target.value)}
                  className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm text-slate-200 focus:outline-none focus:border-blue-500 transition-colors font-bold appearance-none cursor-pointer"
                >
                  {VULN_CLASSES.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>

              <div className="space-y-3">
                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                  <Cpu size={12} /> {t.stack}
                </label>
                <select 
                  value={targetTech}
                  onChange={(e) => setTargetTech(e.target.value)}
                  className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm text-slate-200 focus:outline-none focus:border-blue-500 transition-colors font-bold appearance-none cursor-pointer"
                >
                  {TECH_STACKS.map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>

              <div className="space-y-3">
                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                  <Globe size={12} /> {t.context}
                </label>
                <textarea 
                  value={context}
                  onChange={(e) => setContext(e.target.value)}
                  placeholder={t.contextPlaceholder}
                  className="w-full h-32 bg-slate-950 border border-slate-800 rounded-xl p-4 text-sm text-slate-200 focus:outline-none focus:border-blue-500 transition-colors font-bold resize-none placeholder:text-slate-800"
                />
              </div>
            </div>

            <button 
              onClick={handleForge}
              disabled={loading}
              className="w-full py-4 bg-red-600 hover:bg-red-500 text-white font-black rounded-2xl text-xs transition-all shadow-xl shadow-red-900/30 uppercase tracking-[0.2em] active:scale-95 flex items-center justify-center gap-3 disabled:opacity-50"
            >
              {loading ? <Loader2 size={18} className="animate-spin" /> : <Zap size={18} />}
              {loading ? t.forging : t.forgeBtn}
            </button>
          </div>

          <div className="bg-blue-600/5 border border-blue-500/10 rounded-2xl p-6 space-y-4">
             <div className="flex items-center gap-3 text-blue-500">
                <AlertCircle size={18} />
                <span className="text-[10px] font-black uppercase tracking-widest italic">Compliance Node</span>
             </div>
             <p className="text-[11px] text-slate-500 leading-relaxed font-bold italic">
               Payload generation is strictly monitored. Use only for identifying gaps in existing security controls or validating defensive signatures.
             </p>
          </div>
        </div>

        {/* Output Panel */}
        <div className="lg:col-span-8">
          <div className="card min-h-[600px] flex flex-col overflow-hidden shadow-2xl border-slate-800/50">
            <div className="p-6 border-b border-slate-800 bg-slate-900/40 flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 rounded-xl bg-slate-950 flex items-center justify-center border border-slate-800 shadow-inner">
                  <Code size={20} className="text-blue-500" />
                </div>
                <div>
                   <h3 className="text-sm font-black text-white uppercase tracking-widest italic">{t.output}</h3>
                   <div className="flex items-center gap-2 mt-0.5">
                      <span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse" />
                      <span className="text-[9px] font-black text-slate-500 uppercase tracking-widest">Compiler Active</span>
                   </div>
                </div>
              </div>
              {result && (
                <div className="flex gap-3">
                  <button 
                    onClick={handleCopy}
                    className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl text-[10px] font-black uppercase transition-all"
                  >
                    {copied ? <Check size={14} className="text-green-500" /> : <Copy size={14} />}
                    {t.copy}
                  </button>
                  <button 
                    onClick={() => setResult(null)}
                    className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl text-[10px] font-black uppercase transition-all"
                  >
                    <RefreshCw size={14} />
                    {t.reset}
                  </button>
                </div>
              )}
            </div>

            <div className="flex-1 bg-slate-950/50 p-10 custom-scrollbar relative">
              {!result && !loading && (
                <div className="absolute inset-0 flex flex-col items-center justify-center text-center opacity-20">
                   <Terminal size={120} className="text-slate-800 mb-8" />
                   <h4 className="text-2xl font-black text-slate-600 uppercase tracking-tighter italic">Terminal Standby</h4>
                   <p className="text-xs text-slate-700 font-black uppercase tracking-widest mt-2">Configure parameters and execute neural forging</p>
                </div>
              )}

              {loading && (
                <div className="absolute inset-0 flex flex-col items-center justify-center text-center space-y-8 z-10 bg-slate-950/80 backdrop-blur-sm">
                  <div className="relative">
                    <div className="w-20 h-20 border-8 border-red-500/10 rounded-full" />
                    <div className="w-20 h-20 border-8 border-red-600 rounded-full border-t-transparent animate-spin absolute top-0 shadow-[0_0_20px_rgba(220,38,38,0.3)]" />
                  </div>
                  <div className="space-y-2">
                    <p className="text-2xl font-black text-white uppercase tracking-[0.4em] italic animate-pulse">{t.forging}</p>
                    <p className="text-xs text-slate-500 font-bold italic">Bypassing heuristic constraints...</p>
                  </div>
                </div>
              )}

              {result && (
                <div className="space-y-12 animate-in slide-up">
                  <section className="space-y-6">
                    <div className="flex items-center gap-3">
                       <div className="w-1.5 h-6 bg-red-600 rounded-full" />
                       <h4 className="text-[11px] font-black text-white uppercase tracking-[0.4em]">Synthetic Payload</h4>
                    </div>
                    <div className="group relative">
                      <div className="absolute -inset-0.5 bg-blue-600/20 rounded-2xl blur opacity-0 group-hover:opacity-100 transition-opacity" />
                      <pre className="relative bg-black p-8 rounded-2xl border border-slate-800 font-mono text-sm text-blue-400 overflow-x-auto shadow-2xl leading-relaxed whitespace-pre-wrap">
                        <div className="absolute top-4 right-4 flex gap-2">
                           <div className="w-2 h-2 rounded-full bg-red-500/50" />
                           <div className="w-2 h-2 rounded-full bg-yellow-500/50" />
                           <div className="w-2 h-2 rounded-full bg-green-500/50" />
                        </div>
                        {result.payload}
                      </pre>
                    </div>
                  </section>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <section className="space-y-6">
                       <h4 className="text-[11px] font-black text-slate-500 uppercase tracking-[0.4em] flex items-center gap-3">
                         <ShieldCheck size={16} className="text-blue-500" /> {t.mechanism}
                       </h4>
                       <p className="text-sm text-slate-400 leading-relaxed font-medium italic border-l-4 border-blue-600/30 pl-8 py-4 bg-blue-600/5 rounded-r-2xl">
                         {result.mechanism}
                       </p>
                    </section>
                    <section className="space-y-6">
                       <h4 className="text-[11px] font-black text-slate-500 uppercase tracking-[0.4em] flex items-center gap-3">
                         <Activity size={16} className="text-purple-500" /> {t.behavior}
                       </h4>
                       <p className="text-sm text-slate-400 leading-relaxed font-medium italic border-l-4 border-purple-600/30 pl-8 py-4 bg-purple-600/5 rounded-r-2xl">
                         {result.behavior}
                       </p>
                    </section>
                  </div>

                  <section className="space-y-6 pt-10 border-t border-slate-800">
                     <h4 className="text-[11px] font-black text-slate-500 uppercase tracking-[0.4em] flex items-center gap-3">
                       <ShieldAlert size={16} className="text-green-500" /> {t.remediation}
                     </h4>
                     <div className="bg-green-600/5 border border-green-500/10 p-8 rounded-3xl">
                        <p className="text-sm text-slate-300 leading-relaxed font-bold italic">
                           {result.remediation}
                        </p>
                     </div>
                  </section>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ExploitArchitect;
